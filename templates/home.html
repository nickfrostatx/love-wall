<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Love Wall</title>
    <style>
      .container {
        position: fixed;
        top: 0;
        bottom: 0;
        right: 0;
        left: 0;
      }
      svg {
        display: block;
        margin: 0 auto;
      }
      .location {
        fill: #F06292;
      }
      .map {
        fill: #c3c3c3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <svg></svg>
    </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script>
      var container = d3.select('.container');
      var svg = d3.select('svg');
      var map = svg.insert('svg:path')
        .attr('class', 'map');
      var places = svg.insert('svg:g');

      function draw(events) {
        // Contain in div, preserve 3/2 aspect ratio
        var parentWidth = parseInt(container.style('width')),
          parentHeight = parseInt(container.style('height')),
          ratio = 3/2, width, height;

        if (parentWidth > ratio * parentHeight) {
          height = parentHeight;
          width = height * ratio;
        } else {
          width = parentWidth;
          height = width / ratio;
        }

        svg.attr('width', width);
        svg.attr('height', height);

        var projection = d3.geoMercator()
          .scale(width / 2 / Math.PI)
          .translate([width * .5, height * .7])
          .rotate([-12, 0, 0]);

        places.selectAll('circle')
            .attr('cx', function(evt) {
              return projection(evt.location.coords)[0];
            })
            .attr('cy', function(evt) {
              return projection(evt.location.coords)[1];
            })
          .data(events)
          .enter().append('svg:circle')
            .attr('class', 'location')
            .attr('r', 3)
            .attr('cx', function(evt) {
              return projection(evt.location.coords)[0];
            })
            .attr('cy', function(evt) {
              return projection(evt.location.coords)[1];
            });

        
        
        var path = d3.geoPath()
          .projection(projection);
        
        map.attr('d', path);
      }

      function makeRequests(urls) {
        var getJsonUrl = function(url) {
          return new Promise(function(resolve, reject) {
            d3.json(url, function(error, data) {
              if (error) {
                reject(error);
              } else {
                resolve(data);
              }
            });
          });
        };
        return Promise.all(urls.map(getJsonUrl));
      }

      makeRequests(['/static/world.json', '/events'])
        .then(function(values) {
          var world = values[0], events = values[1];

          map.datum(topojson.feature(world, world.objects.subunits))

          window.addEventListener('resize', function() { draw(events) });
          window.addEventListener('scroll', function() { draw(events) });
          draw(events.events);
        });
    </script>
  </body>
</html>
